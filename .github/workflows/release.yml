name: Create release

on:
  push:
    tags:
      - "v*" # Push events to matching v*, i.e. v1.0, v20.15.10

jobs:
  write-version:
    runs-on: ubuntu-latest
    name: "‚¨ÜÔ∏è Bump Version"
    steps:
      - uses: actions/checkout@v3

      - name: "üîñ Get Tag Version"
        id: get_version
        run: echo ::set-output name=VERSION::${GITHUB_REF#refs/tags/}

      - name: "üîñ Get Brew Version"
        id: get_brew_version
        run: echo "BREW_VERSION=$(echo ${{ steps.get_version.outputs.VERSION }} | tr -d 'v')" >> $GITHUB_ENV

      - name: "‚ûï Update version in version file"
        run: 'echo "${{ steps.get_version.outputs.VERSION }}" > version'
        shell: bash

      - name: "‚ûï Update version in binary"
        run: |
          echo "#!/usr/bin/env bash" > bin/diw
          echo "" >> bin/diw
          echo 'DIR="/usr/local/Cellar/diw/'${{ env.BREW_VERSION }}'"' >> bin/diw
          echo 'php "$DIR/src/DIW.php" "$@"' >> bin/diw
        shell: bash

      - name: "üß¨ Install composer dependencies"
        run: composer install
        shell: bash

      - name: "‚ûï Create release zip file"
        run: tar -czvf diw-${{ env.BREW_VERSION }}.tar.gz LICENSE version composer.* src/* bin/* vendor/*
        shell: bash

      ####### release stuff starts here #######
      - name: "‚úèÔ∏è Generate changelog"
        id: changelog
        uses: metcalfc/changelog-generator@v1.0.1
        with:
          head-ref: ${{ env.BUMPED_COMMIT_SHA }}
          myToken: ${{ secrets.GITHUB_TOKEN }}

      - name: "üöÄ Create GitHub release"
        id: create_release
        uses: actions/create-release@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false

      - name: Upload Release Asset
        id: upload-release-asset
        uses: actions/upload-release-asset@v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./diw-${{ env.BREW_VERSION }}.tar.gz
          asset_name: diw-${{ env.BREW_VERSION }}.tar.gz
          asset_content_type: application/zip

      - name: "‚¨ÜÔ∏è Bump Homebrew formula"
        uses: mislav/bump-homebrew-formula-action@v1
        with:
          homebrew-tap: MarcoFaul/homebrew-diw
          formula-name: diw
          download-url: https://github.com/MarcoFaul/diw/releases/download/v${{ env.BREW_VERSION }}/diw-${{ env.BREW_VERSION }}.tar.gz
        env:
          COMMITTER_TOKEN: ${{ secrets.BREW_TOKEN }}

      - name: "‚¨áÔ∏èÔ∏è Remove old releases"
        uses: dev-drprasad/delete-older-releases@v0.2.0
        with:
          keep_latest: 5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
